<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Dynamically resolving syscalls in C#" /><meta name="author" content="Felipe Gaspar" /><meta property="og:locale" content="en_US" /><meta name="description" content="This post aims to describe and provide example code on how you can dynamically resolve syscalls using only C#." /><meta property="og:description" content="This post aims to describe and provide example code on how you can dynamically resolve syscalls using only C#." /><link rel="canonical" href="https://fgsec.net/posts/Dynamically-resolving-syscalls-in-CSharp/" /><meta property="og:url" content="https://fgsec.net/posts/Dynamically-resolving-syscalls-in-CSharp/" /><meta property="og:site_name" content="Fgsec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-04T13:00:00-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Dynamically resolving syscalls in C#" /><meta name="twitter:site" content="@felipegaspar" /><meta name="twitter:creator" content="@Felipe Gaspar" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Felipe Gaspar"},"description":"This post aims to describe and provide example code on how you can dynamically resolve syscalls using only C#.","url":"https://fgsec.net/posts/Dynamically-resolving-syscalls-in-CSharp/","@type":"BlogPosting","headline":"Dynamically resolving syscalls in C#","dateModified":"2021-10-25T22:23:22-03:00","datePublished":"2021-05-04T13:00:00-03:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://fgsec.net/posts/Dynamically-resolving-syscalls-in-CSharp/"},"@context":"https://schema.org"}</script><title>Dynamically resolving syscalls in C# | Fgsec</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-175924413-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-175924413-1'); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/25889166?s=460&u=f308a01d882082a7c6ca2e2b00858a8de9e3b20a" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Fgsec</a></div><div class="site-subtitle font-italic">So long, and Thanks for All the Fish.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/fgsec" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/felipegaspar" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['dontknowmyemail',''].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Dynamically resolving syscalls in C#</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Dynamically resolving syscalls in C#</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, May 4, 2021, 1:00 PM -0300" > May 4 <i class="unloaded">2021-05-04T13:00:00-03:00</i> </span> by <span class="author"> Felipe Gaspar </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Oct 25, 2021, 10:23 PM -0300" > Oct 25 <i class="unloaded">2021-10-25T22:23:22-03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1221 words">6 min</span></div></div><div class="post-content"><p>This post aims to describe and provide example code on how you can dynamically resolve syscalls using only C#.</p><h2 id="what-are-system-calls">What are System calls?</h2><p><strong>TL;DR</strong>: System calls or just <em>syscalls</em> are used by applications to perform tasks that are executed by the kernel, such as opening files, allocating memory, and so on. In the offensive context, you can use them to evade API hooks used by security products to intercept and record calls from software.</p><p>If you are new to this subject, I would recommend reading <a href="https://jhalon.github.io/utilizing-syscalls-in-csharp-1/">this post by Jack Halon</a>, which explains very well how syscalls work and even how to use them in csharp.</p><h2 id="hard-coding-vs-dynamically-resolving">Hard coding vs Dynamically resolving</h2><p>Why would you want to dynamically resolve syscalls if you can encode those magic numbers directly in your code?</p><p>The simple answer: syscall numbers are different between OS and build versions, and yes, you could bring all those diferent numbers inside your code and choose the one for that system, but why should you?</p><p>We have different approaches that can be used to solve these numbers, without worrying about the OS version of our target.</p><p>It is important to understand that, although we have different approaches, our blue team friends and their tools can also detect us in different ways. A great example of this is the <a href="https://www.cyberbit.com/blog/endpoint-security/malware-mitigation-when-direct-system-calls-are-used/">Cyberbit article</a>, which documents different malware and brings together the pros and cons of techniques used in direct and dynamic resolution of syscalls.</p><h2 id="introduction">Introduction</h2><p>Okay, before we start, remember that the technique presented here is just an example among several forms that exists and not applied to WOW64 binaries (x86 binaries running on x64 system), you should apply the best within your context.</p><p>As a reminder, it’s possible to confirm a hook by inspecting the first bytes of a function memory region, where we would find something like this:</p><div class="language-nasm highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nf">JMP</span> <span class="mi">0132</span><span class="nv">CF08</span>
<span class="nf">TEST</span> <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="mi">7</span><span class="nv">FFE0308</span><span class="p">],</span><span class="mi">01</span>
<span class="nf">JNE</span> <span class="mi">00000015</span>
<span class="nf">SYSCALL</span>
<span class="nf">RET</span>
</pre></table></code></div></div><p>Note the <code class="language-plaintext highlighter-rouge">JMP</code> instruction, this is a common way to divert execution to a different memory region, usually with code that will analyze whether the execution is malicious or not.</p><p>In constrast, the following instructions are a common syscall execution, we can also confirm that the syscall number for “NtAllocateVirtualMemory” is <code class="language-plaintext highlighter-rouge">00000018</code>.</p><div class="language-nasm highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nf">MOV</span> <span class="nv">R10</span><span class="p">,</span><span class="nb">RCX</span>
<span class="nf">MOV</span> <span class="nb">EAX</span><span class="p">,</span><span class="mi">00000018</span>
<span class="nf">TEST</span> <span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="p">[</span><span class="mi">7</span><span class="nv">FFE0308</span><span class="p">],</span><span class="mi">01</span>
<span class="nf">JNE</span> <span class="mi">00000015</span>
<span class="nf">SYSCALL</span>
<span class="nf">RET</span>
</pre></table></code></div></div><p>As you can see, a hooked function prevents obtaining the syscall number. This is one of the problems that techniques like the one that will be presented try to solve.</p><h2 id="hello-neighbor">Hello Neighbor</h2><p>This technique queries the syscall number of neighboring functions to find out the value of the hooked function.</p><p>Let’s look at why and how this is possible.</p><p>If we were to inspect the <a href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#export-directory-table">export directory table</a> from <code class="language-plaintext highlighter-rouge">ntdll.dll</code> in search of the “NtAllocateVirtualMemory” entry, we would obtain a list of exported functions like this:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/post4-01.png" alt="List" /></p><p><em>(I’m using IDA to inspect the file, but you can use tools such as <a href="https://ntcore.com/?page_id=388">CFF Explorer</a>)</em></p><p>This view is useful, but it is not exactly what we need. The vast majority of tools that let us inspect the export table, will sort using the name or the ordinal column, our interest is the address, more specifically the relative virtual address (RVA) of the function, you can read more about it <a href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#general-concepts">here</a>.</p><p>Now, if we sort the table by the address, we will have the following result:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/post4-02.png" alt="" /></p><p>What this means? This means that by sorting by address, we are able to view the neighboring functions. In this case, we now know that <code class="language-plaintext highlighter-rouge">NtQueryValueKey</code> and <code class="language-plaintext highlighter-rouge">NtQueryInformationProcess</code> are neighbors to function <code class="language-plaintext highlighter-rouge">NtAllocateVirtualMemory</code>. Since we don’t know the syscall number of our hooked function, we can discover it from these neighbors.</p><p>Ok, so let’s inspect those instructions to confirm this theory <em>(I’m inspecting the ntdll on disk, so we will not see any hooks here)</em>:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/post4-03.png" alt="" /></p><p>As we can see, the numbers are sequential, so even if the function <code class="language-plaintext highlighter-rouge">NtAllocateVirtualMemory</code> is hooked, we can determine that its value is “0x0018” by subtracting the number from the function <code class="language-plaintext highlighter-rouge">NtQueryInformationProcess</code> or by adding to the function <code class="language-plaintext highlighter-rouge">NtQueryValueKey</code>.</p><p>Also, it is possible to visualize that there is a difference of 20 bytes between each function, this will be especially useful in the next section.</p><h2 id="lets-code">Let’s Code</h2><p>Now that we’ve seen how the technique works, let’s implement it using C#.</p><p>Before we start, let’s organize what we need to make this work:</p><ol><li>Base address of ntdll inside our process<li>The address of exported functions (<a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress">GetProcAddress</a>), this will let us obtain the address for any function inside ntdll.<li>Check if function is hooked<li>Read and copy memory from inside the process</ol><p>We can obtain the base address of ntdll by looping through our process loaded modules with the help of the <code class="language-plaintext highlighter-rouge">System.Diagnostics.Process</code> class:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="n">IntPtr</span> <span class="nf">GetNTDLLBase</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Process</span> <span class="n">hProc</span> <span class="p">=</span> <span class="n">Process</span><span class="p">.</span><span class="nf">GetCurrentProcess</span><span class="p">();</span>
    <span class="k">foreach</span><span class="p">(</span><span class="n">ProcessModule</span> <span class="n">module</span> <span class="k">in</span> <span class="n">hProc</span><span class="p">.</span><span class="n">Modules</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">ModuleName</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">module</span><span class="p">.</span><span class="n">BaseAddress</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>Now, moving to the address of exported functions inside ntdll, we can use P/Invoke to call Win32’s API function <code class="language-plaintext highlighter-rouge">GetProcAddress</code>. It’s really simple to use it, we just need to pass two arguments, the NTDLL base address and the name of the desired function as string:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32"</span><span class="p">,</span> <span class="n">CharSet</span> <span class="p">=</span> <span class="n">CharSet</span><span class="p">.</span><span class="n">Ansi</span><span class="p">,</span> <span class="n">ExactSpelling</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">IntPtr</span> <span class="nf">GetProcAddress</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hModule</span><span class="p">,</span> <span class="kt">string</span> <span class="n">procName</span><span class="p">);</span>

<span class="n">IntPtr</span> <span class="n">ntdllBase</span> <span class="p">=</span> <span class="nf">GetNTDLLBase</span><span class="p">();</span>
<span class="n">IntPtr</span> <span class="n">funcAddress</span> <span class="p">=</span> <span class="nf">GetProcAddress</span><span class="p">(</span><span class="n">ntdllBase</span><span class="p">,</span> <span class="s">"NtAllocateVirtualMemory"</span><span class="p">);</span>     
</pre></table></code></div></div><p>With the function address, we can copy the memory region and inspect the first bytes for a possible hook. We can do this using the <code class="language-plaintext highlighter-rouge">Marshal.Copy()</code> function, resulting in the code below:</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">isHooked</span><span class="p">(</span><span class="kt">byte</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">byte</span> <span class="n">mov</span> <span class="p">=</span> <span class="m">0x4C</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">!=</span> <span class="n">mov</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">byte</span><span class="p">[]</span> <span class="n">instructions</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">4</span><span class="p">];</span>
<span class="n">Marshal</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">funcAddress</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">4</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nf">isHooked</span><span class="p">(</span><span class="n">instructions</span><span class="p">[</span><span class="m">0</span><span class="p">]))</span> <span class="p">{</span>
   <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Function is hooked!"</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Function is NOT hooked!"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The function <code class="language-plaintext highlighter-rouge">isHooked()</code> is just checking if the first byte is diferent from what a normal execution would be (4C8BD1B8). You can do something more reliable by checking all 4 bytes, but for this demonstration this is sufficient.</p><p>Ok, now we know how to tell if our function is hooked, all that remains is to look for the neighbor’s number and deduct the correct value.</p><div class="language-csharp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">syscallStruct</span> <span class="p">=</span> <span class="p">{</span>
  <span class="m">0x4C</span><span class="p">,</span> <span class="m">0x8B</span><span class="p">,</span> <span class="m">0xD1</span><span class="p">,</span>               <span class="c1">// mov r10, rcx</span>
  <span class="m">0xB8</span><span class="p">,</span> <span class="m">0xFF</span><span class="p">,</span> <span class="m">0x00</span><span class="p">,</span> <span class="m">0x00</span><span class="p">,</span> <span class="m">0x00</span><span class="p">,</span>   <span class="c1">// mov eax, FUNC</span>
  <span class="m">0x0F</span><span class="p">,</span> <span class="m">0x05</span><span class="p">,</span>                     <span class="c1">// syscall</span>
  <span class="m">0xC3</span>                            <span class="c1">// ret</span>
<span class="p">};</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">returnBasedOnNeighbor</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">funcAddress</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">byte</span> <span class="n">counter</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">IntPtr</span> <span class="n">nextFuncAddress</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)((</span><span class="n">UInt64</span><span class="p">)</span><span class="n">funcAddress</span> <span class="p">+</span> <span class="p">(</span><span class="n">UInt64</span><span class="p">)</span><span class="m">32</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"Next Neighbor: {0} "</span><span class="p">,</span> <span class="p">(</span><span class="n">nextFuncAddress</span><span class="p">).</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"X"</span><span class="p">)));</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">instructions</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">21</span><span class="p">];</span>
        <span class="n">Marshal</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">nextFuncAddress</span><span class="p">,</span> <span class="n">instructions</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">21</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"Neighbor instructions: {0}"</span><span class="p">,</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">instructions</span><span class="p">).</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"-"</span><span class="p">,</span> <span class="s">" "</span><span class="p">)));</span>
        <span class="k">if</span> <span class="p">(!</span><span class="nf">isHooked</span><span class="p">(</span><span class="n">instructions</span><span class="p">[</span><span class="m">0</span><span class="p">]))</span> <span class="p">{</span>
            <span class="n">syscallStruct</span><span class="p">[</span><span class="m">4</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="n">instructions</span><span class="p">[</span><span class="m">4</span><span class="p">]-</span><span class="n">counter</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">funcAddress</span> <span class="p">=</span> <span class="n">nextFuncAddress</span><span class="p">;</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Neighbor is also hooked ;("</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">counter</span><span class="p">++;</span>
    <span class="p">}</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">returnBasedOnNeighbor()</code> function does just that, with the difference that if our neighbor is also hooked, it continues until it finds one that is not.</p><p>Compiling these functions in a single code, we have a functional example of this technique:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/post4-04.png" alt="" /></p><p>That’s it!</p><p>The complete code will be available on my <a href="https://github.com/fgsec">github</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Dynamically resolving syscalls in C# - Fgsec&url=https://fgsec.net/posts/Dynamically-resolving-syscalls-in-CSharp/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Dynamically resolving syscalls in C# - Fgsec&u=https://fgsec.net/posts/Dynamically-resolving-syscalls-in-CSharp/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Dynamically resolving syscalls in C# - Fgsec&url=https://fgsec.net/posts/Dynamically-resolving-syscalls-in-CSharp/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Dynamically-resolving-syscalls-in-CSharp/">Dynamically resolving syscalls in C#</a><li><a href="/posts/Bypass-Upload-Restrictions-and-Evade-Detection/">Bypass Upload Restrictions and Evade Detection</a><li><a href="/posts/Injecting-dotNet-Assemblies-To-Unmanaged-Processes/">Injecting dotNet Assemblies to Unmanaged Processes</a><li><a href="/posts/From-CSRF-to-RCE/">From CSRF to RCE</a><li><a href="/posts/New-Blog-Again/">New blog again</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Injecting-dotNet-Assemblies-To-Unmanaged-Processes/"><div class="card-body"> <span class="timeago small" > Feb 9 <i class="unloaded">2021-02-09T13:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Injecting dotNet Assemblies to Unmanaged Processes</h3><div class="text-muted small"><p> This is a quick post to show how you can inject your .NET assembly code to unmanaged processes. Generate the ShellCode As an example, I will be using a Mythic implant. But feel free to develop yo...</p></div></div></a></div><div class="card"> <a href="/posts/Bypass-Upload-Restrictions-and-Evade-Detection/"><div class="card-body"> <span class="timeago small" > Jan 22 <i class="unloaded">2021-01-22T13:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bypass Upload Restrictions and Evade Detection</h3><div class="text-muted small"><p> Let’s be honest, bypassing upload restrictions is not something new and usually involves different methods to achieve the same goal: execute your 1337 code on your victim; But you can’t always do t...</p></div></div></a></div><div class="card"> <a href="/posts/From-CSRF-to-RCE/"><div class="card-body"> <span class="timeago small" > Apr 19, 2020 <i class="unloaded">2020-04-19T13:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>From CSRF to RCE</h3><div class="text-muted small"><p> A few days ago I started taking interest in Bolt, a content management that quoting from its github, is a “Sophisticated, lightweight &amp; simple CMS”. The team behind it really did a great job i...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Injecting-dotNet-Assemblies-To-Unmanaged-Processes/" class="btn btn-outline-primary" prompt="Older"><p>Injecting dotNet Assemblies to Unmanaged Processes</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/felipegaspar">Felipe Gaspar</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://fgsec.net{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
